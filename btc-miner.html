<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BTC Mining - V0 Trade</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content { display: none; position: absolute; background-color: rgba(15,23,42,0.95); min-width: 12rem; border: 1px solid rgba(168,85,247,0.2); border-radius: 0.5rem; padding: 0.5rem; z-index: 1000; }
    .dropdown:hover .dropdown-content { display: block; }
  </style>
</head>
<body class="bg-gradient-to-b from-slate-950 via-purple-950 to-slate-950 text-white">
  <!-- Header (kept minimal for brevity) -->
  <header class="sticky top-0 z-50 border-b border-purple-500/20 bg-slate-950/80 backdrop-blur-md">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between py-4">
        <a href="index.html" class="flex items-center gap-2">
          <span class="text-xl font-bold bg-gradient-to-r from-purple-400 via-pink-400 to-cyan-400 bg-clip-text text-transparent">V0 Trade</span>
        </a>
        <nav class="hidden md:flex items-center gap-8">
          <a href="index.html" class="text-sm text-gray-300 hover:text-white transition">Home</a>
          <div class="dropdown">
            <a href="#" class="text-sm text-gray-300 hover:text-white transition">Invest ▼</a>
            <div class="dropdown-content">
              <a href="cryptocurrencies.html" class="block px-4 py-2 text-sm text-gray-300 hover:text-white transition">Cryptocurrencies</a>
              <a href="stocks.html" class="block px-4 py-2 text-sm text-gray-300 hover:text-white transition">Stocks</a>
              <a href="etfs.html" class="block px-4 py-2 text-sm text-gray-300 hover:text-white transition">ETFs</a>
              <a href="precious-metals.html" class="block px-4 py-2 text-sm text-gray-300 hover:text-white transition">Precious Metals</a>
            </div>
          </div>
          <a href="btc-miner.html" class="text-sm text-white font-semibold">BTC Miner</a>
        </nav>
        <div class="hidden md:flex items-center gap-4">
          <a id="accountLink" href="login.html" class="text-sm text-gray-300 hover:text-white transition">Login</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Hero & content (kept as you provided) -->
  <section class="px-4 py-24 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-7xl text-center">
      <h1 class="text-5xl sm:text-6xl font-bold text-white mb-6">BTC Mining</h1>
      <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto">Start AI-powered Bitcoin mining with V0 Trade and boost your hashrate for maximum BTC earnings. Our system is built for secure, fast, and highly profitable cloud mining — no hardware needed.</p>
    </div>
  </section>

  <!-- (Plans area taken from your markup) -->
  <section class="px-4 py-24 sm:px-6 lg:px-8 bg-slate-900/30">
    <div class="mx-auto max-w-7xl">
      <h2 class="text-4xl font-bold text-white text-center mb-4">BTC Mining Plans</h2>
      <p class="text-gray-300 text-center mb-16">Boost your hashrate and earn more BTC daily</p>

      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        <!-- Micro Plan -->
        <div class="plan-card bg-gradient-to-br from-slate-900 to-slate-800 border border-purple-500/20 rounded-xl p-8" data-plan='{"name":"Micro Plan","investment":600,"duration_days":3,"hashrate":"130 TH/s","daily_pct":36}'>
          <h3 class="text-2xl font-bold text-white mb-6">Micro Plan</h3>
          <div class="space-y-3 mb-6">
            <div class="flex justify-between"><span class="text-gray-400">Investment</span><span class="text-white font-bold">$600</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Duration</span><span class="text-white font-semibold">3 Days</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Hashrate</span><span class="text-cyan-400 font-semibold">130 TH/s</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Daily Return</span><span class="text-green-400 font-bold">36%</span></div>
            <div class="flex items-center gap-2 text-purple-400"><span>✓</span><span class="font-semibold">AI Miner Included</span></div>
          </div>
          <button class="buy-btn w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 rounded-lg hover:opacity-90 transition">Buy Now</button>
        </div>

        <!-- Gold Plan -->
        <div class="plan-card bg-gradient-to-br from-slate-900 to-slate-800 border border-purple-500/20 rounded-xl p-8" data-plan='{"name":"Gold Plan","investment":1850,"duration_days":6,"hashrate":"720 TH/s","daily_pct":48}'>
          <h3 class="text-2xl font-bold text-white mb-6">Gold Plan</h3>
          <div class="space-y-3 mb-6">
            <div class="flex justify-between"><span class="text-gray-400">Investment</span><span class="text-white font-bold">$1,850</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Duration</span><span class="text-white font-semibold">6 Days</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Hashrate</span><span class="text-cyan-400 font-semibold">720 TH/s</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Daily Return</span><span class="text-green-400 font-bold">48%</span></div>
            <div class="flex items-center gap-2 text-purple-400"><span>✓</span><span class="font-semibold">AI Miner Included</span></div>
          </div>
          <button class="buy-btn w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 rounded-lg hover:opacity-90 transition">Buy Now</button>
        </div>

        <!-- Silver Plan -->
        <div class="plan-card bg-gradient-to-br from-slate-900 to-slate-800 border border-purple-500/20 rounded-xl p-8" data-plan='{"name":"Silver Plan","investment":2450,"duration_days":13,"hashrate":"2,114 TH/s","daily_pct":40}'>
          <h3 class="text-2xl font-bold text-white mb-6">Silver Plan</h3>
          <div class="space-y-3 mb-6">
            <div class="flex justify-between"><span class="text-gray-400">Investment</span><span class="text-white font-bold">$2,450</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Duration</span><span class="text-white font-semibold">13 Days</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Hashrate</span><span class="text-cyan-400 font-semibold">2,114 TH/s</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Daily Return</span><span class="text-green-400 font-bold">40%</span></div>
            <div class="flex items-center gap-2 text-purple-400"><span>✓</span><span class="font-semibold">AI Miner Included</span></div>
          </div>
          <button class="buy-btn w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 rounded-lg hover:opacity-90 transition">Buy Now</button>
        </div>

        <!-- Diamond Plan -->
        <div class="plan-card bg-gradient-to-br from-slate-900 to-slate-800 border border-purple-500/20 rounded-xl p-8" data-plan='{"name":"Diamond Plan","investment":2200,"duration_days":7,"hashrate":"3,288 TH/s","daily_pct":80}'>
          <h3 class="text-2xl font-bold text-white mb-6">Diamond Plan</h3>
          <div class="space-y-3 mb-6">
            <div class="flex justify-between"><span class="text-gray-400">Investment</span><span class="text-white font-bold">$2,200</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Duration</span><span class="text-white font-semibold">7 Days</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Hashrate</span><span class="text-cyan-400 font-semibold">3,288 TH/s</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Daily Return</span><span class="text-green-400 font-bold">80%</span></div>
            <div class="flex items-center gap-2 text-purple-400"><span>✓</span><span class="font-semibold">AI Miner Included</span></div>
          </div>
          <button class="buy-btn w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 rounded-lg hover:opacity-90 transition">Buy Now</button>
        </div>

        <!-- Top Partner (example) -->
        <div class="bg-gradient-to-br from-purple-900 to-pink-900 border-2 border-purple-400 rounded-xl p-8 md:col-span-2 relative overflow-hidden">
          <h3 class="text-3xl font-bold text-white mb-6">Top Partner</h3>
          <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div class="space-y-3">
              <div class="flex justify-between"><span class="text-gray-300">Investment</span><span class="text-white font-bold text-xl">$15,000</span></div>
              <div class="flex justify-between"><span class="text-gray-300">Duration</span><span class="text-white font-semibold">20 Days</span></div>
              <div class="flex justify-between"><span class="text-gray-300">Hashrate</span><span class="text-cyan-300 font-semibold">899,685 TH/s</span></div>
            </div>
            <div class="space-y-3">
              <div class="flex justify-between"><span class="text-gray-300">Daily Return</span><span class="text-green-300 font-bold text-xl">50%</span></div>
              <div class="flex justify-between"><span class="text-gray-300">Maintenance</span><span class="text-green-300 font-semibold">0%</span></div>
            </div>
          </div>
          <button class="buy-btn w-full bg-white text-purple-900 font-bold py-4 rounded-lg hover:bg-gray-100 transition text-lg" data-plan='{"name":"Top Partner","investment":15000,"duration_days":20,"hashrate":"899,685 TH/s","daily_pct":50}'>Buy Now</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal -->
  <div id="investmentModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-slate-900 border border-purple-500/30 rounded-2xl p-8 max-w-md w-full">
      <h3 class="text-2xl font-bold text-white mb-6" id="modalTitle">Confirm Purchase</h3>
      <div id="modalContent" class="space-y-4 mb-6"></div>
      <div class="flex gap-4">
        <button id="cancelBtn" class="flex-1 bg-slate-800 text-white font-bold py-3 rounded-lg hover:bg-slate-700 transition">Cancel</button>
        <button id="confirmButton" class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 rounded-lg hover:opacity-90 transition">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Footer kept minimal -->
  <footer class="border-t border-purple-500/20 bg-slate-950 py-12">
    <div class="mx-auto max-w-7xl">
      <div class="border-t border-purple-500/20 pt-8">
        <p class="text-xs text-gray-500 text-center">© 2025 V0 Trade. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    /* -------------------------
       CONFIG - Change token here
       ------------------------- */
    const BASEROW_TOKEN = 'LG6hnTBxgBG78FueElsSwpHRd4Wep1oL'; // replace if needed
    const WALLET_TABLE_ID = '756077';
    const INVESTMENT_TABLE_ID = '756316';
    const BASEROW_API_ROOT = 'https://api.baserow.io/api/database/rows/table';

    /* -------------------------
       FIELD IDS (as confirmed)
       ------------------------- */
    // Wallet table (756077)
    const WALLET_FIELD_EMAIL = 'field_6394418';
    const WALLET_FIELD_DEPOSIT = 'field_6394419';

    // Investment table (756316)
    const INV_FIELD_AMOUNT = 'field_6397378';
    const INV_FIELD_DAILY = 'field_6397379';
    const INV_FIELD_TOTAL = 'field_6397380';
    const INV_FIELD_HASHRATE = 'field_6397381';
    const INV_FIELD_DURATION = 'field_6397382';
    const INV_FIELD_EMAIL = 'field_6397383';
    const INV_FIELD_TYPE = 'field_6406096';

    /* -------------------------
       Helpers
       ------------------------- */
    function isLoggedIn() {
      const e = localStorage.getItem('v0trade_user_email');
      return e && e.length > 0;
    }

    function getLoggedInEmail() {
      return localStorage.getItem('v0trade_user_email') || '';
    }

    function showModal(title, htmlContent, onConfirm) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalContent').innerHTML = htmlContent;
      document.getElementById('investmentModal').classList.remove('hidden');
      const confirmBtn = document.getElementById('confirmButton');
      confirmBtn.disabled = false;
      confirmBtn.onclick = async () => {
        confirmBtn.disabled = true;
        try {
          await onConfirm();
        } catch (e) {
          console.error(e);
        } finally {
          // keep modal open for success handler to close it or close on error too
        }
      };
      document.getElementById('cancelBtn').onclick = () => {
        document.getElementById('investmentModal').classList.add('hidden');
      };
    }

    function closeModal() {
      document.getElementById('investmentModal').classList.add('hidden');
    }

    function formatCurrency(n) {
      return '$' + Number(n).toFixed(2);
    }

    /* -------------------------
       Baserow API operations
       Using field IDs directly (no user_field_names)
       ------------------------- */
    async function fetchAllWalletRows(page = 1, pageSize = 100) {
      const url = `${BASEROW_API_ROOT}/${WALLET_TABLE_ID}/?page=${page}&page_size=${pageSize}`;
      const res = await fetch(url, {
        headers: { 'Authorization': `Token ${BASEROW_TOKEN}` }
      });
      if (!res.ok) throw new Error('Failed fetching wallet rows: ' + res.status);
      return res.json();
    }

    async function getWalletRowByEmail(email) {
      // We fetch first page_size large enough to include all common users. If you have >100 rows consider looping pages.
      try {
        const json = await fetchAllWalletRows(1, 200);
        const rows = json.results || [];
        // Rows use field IDs directly: row[field_xxxxx]
        const found = rows.find(r => {
          const fv = (r[WALLET_FIELD_EMAIL] ?? r.values?.[WALLET_FIELD_EMAIL] ?? null);
          return fv && String(fv).toLowerCase() === String(email).toLowerCase();
        });
        if (!found) return null;
        // deposit balance may be stored as number or string. normalize:
        let depositVal = found[WALLET_FIELD_DEPOSIT] ?? (found.values && found.values[WALLET_FIELD_DEPOSIT]);
        if (typeof depositVal === 'string') {
          depositVal = depositVal.replace(/[$,]/g, '').trim();
        }
        const balance = Number(depositVal) || 0;
        return { rowId: found.id, balance };
      } catch (err) {
        console.error('getWalletRowByEmail error', err);
        throw err;
      }
    }

    async function patchWalletBalance(rowId, newBalance) {
      const url = `${BASEROW_API_ROOT}/${WALLET_TABLE_ID}/${rowId}/`;
      const body = {};
      body[WALLET_FIELD_DEPOSIT] = Number(newBalance);
      const res = await fetch(url, {
        method: 'PATCH',
        headers: {
          'Authorization': `Token ${BASEROW_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        console.error('Failed to PATCH wallet balance', res.status);
        return false;
      }
      return true;
    }

    async function createInvestmentRow(payloadFields) {
      const url = `${BASEROW_API_ROOT}/${INVESTMENT_TABLE_ID}/`;
      const body = payloadFields;
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': `Token ${BASEROW_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const text = await res.text().catch(()=>null);
        console.error('createInvestmentRow failed', res.status, text);
        return null;
      }
      return res.json();
    }

    /* -------------------------
       Process purchase flow
       ------------------------- */
    async function handleBuy(plan) {
      if (!isLoggedIn()) {
        showModal('Login Required', `<p class="text-gray-300">You must be logged in to purchase a plan.</p>
          <p class="text-gray-400 text-sm mt-2">Redirecting to login...</p>`, async () => {
            window.location.href = 'login.html';
          });
        return;
      }

      const email = getLoggedInEmail();
      const investment = Number(plan.investment);
      const days = Number(plan.duration_days);
      const dailyPct = Number(plan.daily_pct);

      const dailyReturnAmount = (investment * dailyPct / 100);
      const totalExpected = (investment + dailyReturnAmount * days);

      // Prepare modal content
      const modalHtml = `
        <div class="space-y-3">
          <div class="flex justify-between text-gray-300"><span>Plan:</span><span class="text-white font-semibold">${plan.name}</span></div>
          <div class="flex justify-between text-gray-300"><span>Investment:</span><span class="text-white font-semibold">${formatCurrency(investment)}</span></div>
          <div class="flex justify-between text-gray-300"><span>Duration:</span><span class="text-white font-semibold">${days} Days</span></div>
          <div class="flex justify-between text-gray-300"><span>Hashrate:</span><span class="text-cyan-400 font-semibold">${plan.hashrate}</span></div>
          <div class="flex justify-between text-gray-300"><span>Daily Return:</span><span class="text-green-400 font-semibold">${dailyPct}% (${formatCurrency(dailyReturnAmount)})</span></div>
          <div class="flex justify-between text-gray-300"><span>Total Expected:</span><span class="text-purple-400 font-bold text-xl">${formatCurrency(totalExpected)}</span></div>
          <div class="pt-3 text-sm text-gray-400">Your account email: <span class="text-white">${email}</span></div>
        </div>
      `;

      // Confirm -> then process
      showModal('Confirm Purchase', modalHtml, async () => {
        try {
          // Update modal to processing state
          document.getElementById('modalContent').innerHTML = '<p class="text-center text-gray-300">Processing payment and creating investment...</p>';

          // 1) find wallet row
          let walletRow;
          try {
            walletRow = await getWalletRowByEmail(email);
          } catch (e) {
            document.getElementById('modalContent').innerHTML = `<p class="text-center text-red-400">Failed to read wallet. Please contact support.</p>`;
            return;
          }

          if (!walletRow) {
            document.getElementById('modalContent').innerHTML = `<p class="text-center text-red-400">Wallet not found for ${email}. Please contact support or deposit funds.</p>`;
            return;
          }

          // 2) check balance
          if (walletRow.balance < investment) {
            document.getElementById('modalContent').innerHTML = `
              <p class="text-center text-gray-300">Insufficient balance to buy the ${plan.name}.</p>
              <p class="text-gray-400 text-sm mt-2">Balance: ${formatCurrency(walletRow.balance)} | Required: ${formatCurrency(investment)}</p>
              <div class="mt-4 text-center"><button id="goDeposit" class="px-4 py-2 bg-purple-600 rounded">Deposit Now</button></div>
            `;
            document.getElementById('confirmButton').disabled = true;
            document.getElementById('goDeposit').onclick = () => window.location.href = 'dashboard.html#funds';
            return;
          }

          // 3) deduct balance in Baserow
          const newBalance = Number((walletRow.balance - investment).toFixed(2));
          const patched = await patchWalletBalance(walletRow.rowId, newBalance);
          if (!patched) {
            document.getElementById('modalContent').innerHTML = `<p class="text-center text-red-400">Failed to debit your wallet. Payment not completed.</p>`;
            return;
          }

          // 4) create investment row in investments table using confirmed field ids
          const invPayload = {};
          invPayload[INV_FIELD_AMOUNT] = Number(investment);
          invPayload[INV_FIELD_DAILY] = Number(dailyReturnAmount);
          invPayload[INV_FIELD_TOTAL] = Number(totalExpected);
          invPayload[INV_FIELD_HASHRATE] = plan.hashrate;
          invPayload[INV_FIELD_DURATION] = Number(days);
          invPayload[INV_FIELD_EMAIL] = email;
          invPayload[INV_FIELD_TYPE] = plan.name;

          const created = await createInvestmentRow(invPayload);
          if (!created) {
            // roll back wallet balance
            await patchWalletBalance(walletRow.rowId, walletRow.balance).catch(()=>{});
            document.getElementById('modalContent').innerHTML = `<p class="text-center text-red-400">Failed to create investment. Your funds were restored. Please contact support.</p>`;
            return;
          }

          // success
          document.getElementById('modalContent').innerHTML = `
            <p class="text-center text-green-400 font-semibold">Success! ${plan.name} activated.</p>
            <p class="text-center text-gray-300 mt-3">Investment created and your wallet balance updated to ${formatCurrency(newBalance)}.</p>
            <div class="mt-4 text-center"><button id="toDashboard" class="px-4 py-2 bg-purple-600 rounded">Go to Dashboard</button></div>
          `;

          document.getElementById('toDashboard').onclick = () => {
            closeModal();
            window.location.href = 'dashboard.html';
          };

        } catch (err) {
          console.error('process error', err);
          document.getElementById('modalContent').innerHTML = `<p class="text-center text-red-400">Unexpected error. Please contact support.</p>`;
        }
      });
    }

    /* -------------------------
       Wire up buttons on DOM ready
       ------------------------- */
    document.addEventListener('DOMContentLoaded', function() {
      // update header account link if logged in
      const accountLink = document.getElementById('accountLink');
      if (isLoggedIn()) {
        accountLink.textContent = 'My Account';
        accountLink.href = 'dashboard.html';
      } else {
        accountLink.textContent = 'Login';
        accountLink.href = 'login.html';
      }

      // attach buy handlers
      document.querySelectorAll('.plan-card .buy-btn, .buy-btn[data-plan]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          // plan can be on parent data-plan or on button data-plan
          let el = e.currentTarget;
          let planData = null;
          try {
            // prefer data-plan attribute on button first
            const dp = el.getAttribute('data-plan');
            if (dp) planData = JSON.parse(dp);
            else {
              // find nearest ancestor .plan-card
              const card = el.closest('.plan-card');
              if (card) planData = JSON.parse(card.getAttribute('data-plan'));
            }
          } catch (err) {
            console.error('invalid plan data', err);
            return alert('Plan data error');
          }
          if (!planData) return alert('Plan data not found');
          handleBuy(planData);
        });
      });
    });
  </script>
</body>
</html>
